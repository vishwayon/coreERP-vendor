!function(a,b){a.widget("daredevel.tree",{_attachLi:function(c,d,e){var f=d.find("ul:first");f.length?b==e||f.children("li").length<e?f.append(c):(0==e&&(e+=1),f.children("li:nth-child("+e+")").before(c)):(f=a("<ul/>"),d.append(f.append(c)))},_attachNode:function(a,c,d){if(b==c){var e=this.element;this._attachLi(a,e,d),this._initializeNode(a)}else{var e=c;this._attachLi(a,e,d),e.removeClass("leaf collapsed").addClass("expanded"),this._initializeNode(a),this._initializeNode(e)}},_buildNode:function(b){b=a.extend(!0,this.options.defaultNodeAttributes,b);var c=a("<span/>",b.span),d=a("<li/>",b.li);if(a.inArray("checkbox",this.options.components)>-1){var e=a("<input/>",b.input);d.append(e)}return d.append(c),d},_create:function(){var b=this;this.options.core=this,this.element.addClass("ui-widget ui-widget-content daredevel-tree"),this.options.checkbox&&this._createCheckbox(),this.options.collapsible&&this._createCollapsible(),this.options.dnd&&this._createDnd(),this.options.selectable&&this._createSelectable(),this.element.find("li").each(function(){b._initializeNode(a(this))}),null!=this.options.nodes&&a.each(this.options.nodes,function(a,c){b.options.core.addNode(c)})},_destroy:function(){a.Widget.prototype.destroy.call(this)},_detachNode:function(a){var b=this.options.core.parentNode(a),c=b.find("ul:first");1==c.children().length?(c.detach(),b.removeClass("collapsed expanded").addClass("leaf")):a.detach(),this.options.core._initializeNode(b)},_initializeComponents:function(){for(var a in this.options.components){var b="element.tree"+this.options.components[a]+"(options);";run=new Function("options","element",b),run(this.options,this.element)}},_initializeNode:function(a){a.children("span:last").addClass("daredevel-tree-label"),this.options.checkbox&&this._initializeCheckboxNode(a),this.options.collapsible&&this._initializeCollapsibleNode(a),this.options.dnd&&this._initializeDndNode(a),this.options.selectable&&this._initializeSelectableNode(a)},addNode:function(c,d,e){var f=this,g=this._buildNode(c);b==d||0==d.length?this._attachNode(a(g),b,e):this._attachNode(a(g),a(d),e),b!=c.children&&a.each(c.children,function(a,b){f.addNode(b,g)}),f._trigger("add",!0,g)},isRoot:function(b){b=a(b);var c=b.parentsUntil(".daredevel-tree");return 1==c.length},moveNode:function(c,d,e){this._detachNode(a(c)),b==d||0==d.length?this._attachNode(a(c),b,e):this._attachNode(a(c),a(d),e),this._trigger("move",!0,a(c))},parentNode:function(b){return a(b).parents("li:first")},removeNode:function(b){this._detachNode(a(b)),this._trigger("remove",!0,a(b))},_allDescendantChecked:function(a){return 0==a.find("li input:checkbox:not(:checked)").length},_checkAncestors:function(a){a.parentsUntil("daredevel-tree").filter("li").find("input:checkbox:first:not(:checked)").prop("checked",!0).change()},_checkDescendants:function(a){a.find("li input:checkbox:not(:checked)").prop("checked",!0).change()},_checkOthers:function(b){b.addClass("exclude"),b.parents("li").addClass("exclude"),b.find("li").addClass("exclude"),a(this.element).find("li").each(function(){a(this).hasClass("exclude")||a(this).find("input:checkbox:first:not(:checked)").prop("checked",!0).change()}),a(this.element).find("li").removeClass("exclude")},_createCheckbox:function(){var b=this;this.element.on("click","input:checkbox:not(:checked)",function(){b.uncheck(b.options.core.parentNode(a(this)))}),this.element.on("click","input:checkbox:checked",function(){b.check(b.options.core.parentNode(a(this)))}),"collapse"==this.options.onUncheck.node?this.element.on("click","input:checkbox:not(:checked)",function(){b.options.core.collapse(b.options.core.parentNode(a(this)))}):"expand"==this.options.onUncheck.node&&this.element.on("click","input:checkbox:not(:checked)",function(){b.options.core.expand(b.options.core.parentNode(a(this)))}),"collapse"==this.options.onCheck.node?this.element.on("click","input:checkbox:checked",function(){b.options.core.collapse(b.options.core.parentNode(a(this)))}):"expand"==this.options.onCheck.node&&this.element.on("click","input:checkbox:checked",function(){b.options.core.expand(b.options.core.parentNode(a(this)))})},_initializeCheckboxNode:function(){},_uncheckAncestors:function(a){a.parentsUntil("daredevel-tree").filter("li").find("input:checkbox:first:checked").prop("checked",!1).change()},_uncheckDescendants:function(a){a.find("li input:checkbox:checked").prop("checked",!1).change()},_uncheckOthers:function(b){b.addClass("exclude"),b.parents("li").addClass("exclude"),b.find("li").addClass("exclude"),a(this.element).find("li").each(function(){a(this).hasClass("exclude")||a(this).find("input:checkbox:first:checked").prop("checked",!1).change()}),a(this.element).find("li").removeClass("exclude")},check:function(b){if(b=a(b),b.find("input:checkbox:first:not(:checked)").prop("checked",!0).change(),"check"==this.options.onCheck.others?this._checkOthers(b):"uncheck"==this.options.onCheck.others&&this._uncheckOthers(b),"check"==this.options.onCheck.descendants?this._checkDescendants(b):"uncheck"==this.options.onCheck.descendants&&this._uncheckDescendants(b),"check"==this.options.onCheck.ancestors)this._checkAncestors(b);else if("uncheck"==this.options.onCheck.ancestors)this._uncheckAncestors(b);else if("checkIfFull"==this.options.onCheck.ancestors){var c=this.options.core.isRoot(b),d=this._allDescendantChecked(this.options.core.parentNode(b));!c&&d&&this.check(this.options.core.parentNode(b))}},checkAll:function(){a(this.element).find("input:checkbox:not(:checked)").prop("checked",!0).change()},uncheck:function(b){b=a(b),b.find("input:checkbox:first:checked").prop("checked",!1).change(),"check"==this.options.onUncheck.others?this._checkOthers(b):"uncheck"==this.options.onUncheck.others&&this._uncheckOthers(b),"check"==this.options.onUncheck.descendants?this._checkDescendants(b):"uncheck"==this.options.onUncheck.descendants&&this._uncheckDescendants(b),"check"==this.options.onUncheck.ancestors?this._checkAncestors(b):"uncheck"==this.options.onUncheck.ancestors&&this._uncheckAncestors(b)},uncheckAll:function(){a(this.element).find("input:checkbox:checked").prop("checked",!1).change()},_createCollapsible:function(){var b=this;this.element.on("click","li span.daredevel-tree-anchor",function(){var c=b.options.core.parentNode(a(this));c.hasClass("collapsed")?b.expand(c):c.hasClass("expanded")&&b.collapse(c)})},_initializeCollapsibleNode:function(b){var c=this,d=b.children("span.daredevel-tree-anchor");d.length<1&&b.prepend(a("<span />",{"class":"daredevel-tree-anchor"})),b.hasClass("leaf")?c._markAsLeaf(b):b.hasClass("collapsed")?c.collapse(b,!1,!0):b.hasClass("expanded")?c.expand(b,!1,!0):b.is("li:not(:has(ul))")?c._markAsLeaf(b):c._markAsExpanded(b)},_markAsCollapsed:function(a){var b=a.children("span.daredevel-tree-anchor");b.removeClass("ui-icon "+this.options.expandUiIcon+" "+this.options.leafUiIcon),this.options.collapseUiIcon.length>0&&b.addClass("ui-icon "+this.options.collapseUiIcon),a.removeClass("leaf").removeClass("expanded").addClass("collapsed")},_markAsExpanded:function(a){var b=a.children("span.daredevel-tree-anchor");b.removeClass("ui-icon "+this.options.collapseUiIcon+" "+this.options.leafUiIcon),this.options.expandUiIcon.length>0&&b.addClass("ui-icon "+this.options.expandUiIcon),a.removeClass("leaf").removeClass("collapsed").addClass("expanded")},_markAsLeaf:function(a){var b=a.children("span.daredevel-tree-anchor");b.removeClass("ui-icon "+this.options.collapseUiIcon+" "+this.options.expandUiIcon),this.options.leafUiIcon.length>0&&b.addClass("ui-icon "+this.options.leafUiIcon),a.removeClass("collapsed").removeClass("expanded").addClass("leaf")},_unmark:function(){li.removeClass("collapsed expanded leaf")},collapse:function(c,d,e){if(c=a(c),e==b&&(e=!1),e||!c.hasClass("collapsed")&&!c.hasClass("leaf")){d==b&&(d=!0);var f=this;d?(c.children("ul").hide(this.options.collapseEffect,{},this.options.collapseDuration),setTimeout(function(){f._markAsCollapsed(c,f.options)},f.options.collapseDuration)):(c.children("ul").hide(),f._markAsCollapsed(c,f.options)),f.options.core._trigger("collapse",!0,c)}},collapseAll:function(){var b=this;a(this.element).find("li.expanded").each(function(){b.collapse(a(this))})},expand:function(c,d,e){if(c=a(c),e==b&&(e=!1),e||!c.hasClass("expanded")&&!c.hasClass("leaf")){d==b&&(d=!0);var f=this;d?(c.children("ul").show(f.options.expandEffect,{},f.options.expandDuration),setTimeout(function(){f._markAsExpanded(c,f.options)},f.options.expandDuration)):(c.children("ul").show(),f._markAsExpanded(c,f.options)),f.options.core._trigger("expand",!0,c)}},expandAll:function(){var b=this;a(this.element).find("li.collapsed").each(function(){b.expand(a(this))})},_createDnd:function(){},_initializeDndNode:function(c){var d=this,e=a("<span/>",{"class":"prepended",html:"<br/>"}).droppable({hoverClass:"over",drop:function(c,e){var f=a(this).closest("li");if(d.options.core.isRoot(f)){var g=b;d.options.core.element}else{var g=f.parent().closest("li");if(a(e.draggable.parent("li")).find(g).length)return}var i=a(a(this).parent("li")).index()+1;d.options.core.moveNode(e.draggable.parent("li"),g,i),d._trigger("drop",c,{draggable:e.draggable,droppable:g})}});a(c).find(".daredevel-tree-label:first").after(e),a(c).find(".daredevel-tree-label:first").draggable({start:function(){a(this).parent("li").find("ul, .prepended").css("visibility","hidden"),a(this).parent("li").find(".droppable-label").css("display","none")},stop:function(){a(this).parent("li").find("ul").css("visibility","visible"),a(this).parent("li").find(".prepended").css("visibility",""),a(this).parent("li").find(".droppable-label").css("display","inherit")},revert:!0,revertDuration:0});var e=a("<span/>",{"class":"droppable-label",html:"<br/>"}).droppable({drop:function(b,c){var e=a(this).closest("li");a(c.draggable.parent("li")).find(e).length||(d.options.core.moveNode(c.draggable.parent("li"),e,1),d._trigger("drop",b,{draggable:c.draggable,droppable:e}))},over:function(){a(this).parent("li").find(".daredevel-tree-label:first").addClass("ui-state-hover")},out:function(){a(this).parent("li").find(".daredevel-tree-label:first").removeClass("ui-state-hover")}});a(c).find(".daredevel-tree-label:first").after(e)},_createSelectable:function(){var b=this;this.element.on("click",".daredevel-tree-label",function(){var c=a(this);c.hasClass(b.options.selectUiClass)?b.deselect(a(this).parent(c)):b.select(a(this).parent("li"))})},_deselect:function(a){a.find("span.daredevel-tree-label:first").removeClass(this.options.selectUiClass),this._trigger("deselect",!0,a)},_deselectAll:function(){var b=this;this.element.find(".daredevel-tree-label."+this.options.selectUiClass).each(function(){b._deselect(a(this).parent("li"))})},_destroySelectable:function(){},_initializeSelectableNode:function(){},_select:function(a){a.find("span.daredevel-tree-label:first").addClass(this.options.selectUiClass),this._trigger("select",!0,a)},deselect:function(b){b=a(b),this._deselect(b)},select:function(b){b=a(b),this.options.selectUnique&&this._deselectAll(),this._select(b)},selected:function(){var b=this.element.find(".daredevel-tree-label."+this.options.selectUiClass);return a(b).parent()},options:{defaultNodeAttributes:{span:{html:"new node"},li:{"class":"leaf"},input:{type:"checkbox"}},nodes:null,checkbox:!0,onCheck:{ancestors:"check",descendants:"check",node:"",others:""},onUncheck:{ancestors:"",descendants:"uncheck",node:"",others:""},collapsible:!0,collapseDuration:500,collapseEffect:"blind",collapseUiIcon:"ui-icon-triangle-1-e",expandDuration:500,expandEffect:"blind",expandUiIcon:"ui-icon-triangle-1-se",leafUiIcon:"",dnd:!0,drop:function(){},selectable:!0,deselect:function(){},selectUiClass:"ui-state-active",selectUnique:!0,select:function(){}}}),a.ui.draggable.prototype._getRelativeOffset=function(){if("relative"==this.cssPosition){var a=this.element.position();return{top:a.top-(parseInt(this.helper.css("top"),10)||0),left:a.left-(parseInt(this.helper.css("left"),10)||0)}}return{top:0,left:0}}}(jQuery);
